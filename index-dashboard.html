<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Monde des Curieux - Accueil</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles/curio-main.css">
    <link rel="stylesheet" href="styles/dashboard-home.css">
</head>
<body class="dashboard-home">
    <div class="container">
        <!-- HEADER GLOBAL -->
        <header class="main-header">
            <div class="logo-section">
                <h1 class="main-title">üéÆ Le Monde des Curieux</h1>
                <p class="subtitle">Apprends en t'amusant !</p>
            </div>
            
            <div class="global-stats">
                <div class="stat-card">
                    <span class="stat-icon">üî•</span>
                    <span class="stat-value" id="global-streak">0</span>
                    <span class="stat-label">jours</span>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">‚ù§Ô∏è</span>
                    <span class="stat-value" id="global-hearts">5</span>
                    <span class="stat-label">c≈ìurs</span>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">‚≠ê</span>
                    <span class="stat-value" id="global-xp">0</span>
                    <span class="stat-label">XP</span>
                </div>
                <div class="stat-card">
                    <span class="stat-icon">üìä</span>
                    <span class="stat-value" id="global-level">1</span>
                    <span class="stat-label">Niveau</span>
                </div>
            </div>
        </header>

        <!-- RECOMMANDATION -->
        <div class="recommendation-banner" id="recommendation-banner" style="display: none;">
            <div class="recommendation-icon">üí°</div>
            <div class="recommendation-text">
                <strong>Continue ton apprentissage !</strong>
                <span id="recommendation-message"></span>
            </div>
        </div>

        <!-- SECTIONS GRID -->
        <div class="sections-grid">
            
            <!-- SECTION MATH√âMATIQUES -->
            <div class="section-card maths-card" onclick="window.location.href='maths_duolingo_section.html'">
                <div class="section-header">
                    <span class="section-emoji">üßÆ</span>
                    <h2 class="section-title">Math√©matiques</h2>
                </div>
                
                <div class="section-description">
                    Calcul mental, g√©om√©trie, probl√®mes et fractions
                </div>
                
                <div class="section-stats">
                    <div class="progress-info">
                        <span class="progress-label">Progression</span>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini maths-progress" id="maths-progress" style="width: 0%"></div>
                        </div>
                        <span class="progress-percentage" id="maths-percentage">0%</span>
                    </div>
                    
                    <div class="section-metrics">
                        <span class="metric"><strong id="maths-completed">0</strong>/15 le√ßons</span>
                        <span class="metric"><strong id="maths-xp">0</strong> XP</span>
                    </div>
                </div>
                
                <button class="section-button maths-button">
                    Continuer ‚Üí
                </button>
            </div>

            <!-- SECTION ENGLISH -->
            <div class="section-card english-card" onclick="window.location.href='english_duolingo_section.html'">
                <div class="section-header">
                    <span class="section-emoji">üåç</span>
                    <h2 class="section-title">English</h2>
                </div>
                
                <div class="section-description">
                    Vocabulaire, phrases courantes et prononciation
                </div>
                
                <div class="section-stats">
                    <div class="progress-info">
                        <span class="progress-label">Progression</span>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini english-progress" id="english-progress" style="width: 0%"></div>
                        </div>
                        <span class="progress-percentage" id="english-percentage">0%</span>
                    </div>
                    
                    <div class="section-metrics">
                        <span class="metric"><strong id="english-completed">0</strong>/15 le√ßons</span>
                        <span class="metric"><strong id="english-xp">0</strong> XP</span>
                    </div>
                </div>
                
                <button class="section-button english-button">
                    Continuer ‚Üí
                </button>
            </div>

            <!-- SECTION FRAN√áAIS -->
            <div class="section-card francais-card" onclick="window.location.href='francais_duolingo_section.html'">
                <div class="section-header">
                    <span class="section-emoji">üìö</span>
                    <h2 class="section-title">Fran√ßais</h2>
                </div>
                
                <div class="section-description">
                    Grammaire, conjugaison, orthographe et vocabulaire
                </div>
                
                <div class="section-stats">
                    <div class="progress-info">
                        <span class="progress-label">Progression</span>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini francais-progress" id="francais-progress" style="width: 0%"></div>
                        </div>
                        <span class="progress-percentage" id="francais-percentage">0%</span>
                    </div>
                    
                    <div class="section-metrics">
                        <span class="metric"><strong id="francais-completed">0</strong>/15 le√ßons</span>
                        <span class="metric"><strong id="francais-xp">0</strong> XP</span>
                    </div>
                </div>
                
                <button class="section-button francais-button">
                    Continuer ‚Üí
                </button>
            </div>

            <!-- SECTION HISTOIRE -->
            <div class="section-card histoire-card" onclick="window.location.href='histoire_duolingo_section.html'">
                <div class="section-header">
                    <span class="section-emoji">üèõÔ∏è</span>
                    <h2 class="section-title">Histoire</h2>
                </div>
                
                <div class="section-description">
                    De la Pr√©histoire au XXe si√®cle, frises et monuments
                </div>
                
                <div class="section-stats">
                    <div class="progress-info">
                        <span class="progress-label">Progression</span>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini histoire-progress" id="histoire-progress" style="width: 0%"></div>
                        </div>
                        <span class="progress-percentage" id="histoire-percentage">0%</span>
                    </div>
                    
                    <div class="section-metrics">
                        <span class="metric"><strong id="histoire-completed">0</strong>/15 le√ßons</span>
                        <span class="metric"><strong id="histoire-xp">0</strong> XP</span>
                    </div>
                </div>
                
                <button class="section-button histoire-button">
                    Continuer ‚Üí
                </button>
            </div>

            <!-- SECTION SCIENCES -->
            <div class="section-card sciences-card" onclick="window.location.href='sciences_duolingo_section.html'">
                <div class="section-header">
                    <span class="section-emoji">üî¨</span>
                    <h2 class="section-title">Sciences</h2>
                </div>
                
                <div class="section-description">
                    Syst√®me solaire, corps humain, exp√©riences et nature
                </div>
                
                <div class="section-stats">
                    <div class="progress-info">
                        <span class="progress-label">Progression</span>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini sciences-progress" id="sciences-progress" style="width: 0%"></div>
                        </div>
                        <span class="progress-percentage" id="sciences-percentage">0%</span>
                    </div>
                    
                    <div class="section-metrics">
                        <span class="metric"><strong id="sciences-completed">0</strong>/15 le√ßons</span>
                        <span class="metric"><strong id="sciences-xp">0</strong> XP</span>
                    </div>
                </div>
                
                <button class="section-button sciences-button">
                    Continuer ‚Üí
                </button>
            </div>

        </div>

        <!-- FOOTER INFO -->
        <footer class="dashboard-footer">
            <p>üéØ <strong>75 le√ßons</strong> disponibles ‚Ä¢ üìù <strong>600+ exercices</strong> √©ducatifs</p>
            <p>Version 2.0 - Le Monde des Curieux ¬© 2025</p>
        </footer>
    </div>

    <!-- SCRIPT UNIFI√â PROGRESSION GLOBALE -->
    <script src="scripts/modules/storage.js"></script>
    <script>
        // ========================================
        // SYST√àME UNIFI√â DE PROGRESSION
        // ========================================
        
        const SECTIONS_CONFIG = [
            { key: 'maths', name: 'Math√©matiques', emoji: 'üßÆ', url: 'maths_duolingo_section.html', totalLessons: 15 },
            { key: 'english', name: 'English', emoji: 'üåç', url: 'english_duolingo_section.html', totalLessons: 15 },
            { key: 'francais', name: 'Fran√ßais', emoji: 'üìö', url: 'francais_duolingo_section.html', totalLessons: 15 },
            { key: 'histoire', name: 'Histoire', emoji: 'üèõÔ∏è', url: 'histoire_duolingo_section.html', totalLessons: 15 },
            { key: 'sciences', name: 'Sciences', emoji: 'üî¨', url: 'sciences_duolingo_section.html', totalLessons: 15 }
        ];

        document.addEventListener('DOMContentLoaded', () => {
            loadGlobalStats();
            loadSectionsProgress();
            showRecommendation();
        });

        // ========================================
        // SYST√àME DE STOCKAGE UNIFI√â
        // ========================================
        
        class UnifiedStorage {
            // R√©cup√®re les donn√©es d'une section (compatible avec diff√©rentes structures)
            static getSectionData(sectionKey) {
                const data = {
                    completed: [],
                    xp: 0,
                    streak: 0,
                    hearts: 5,
                    level: 1
                };

                // Essayer diff√©rentes structures de cl√©s localStorage
                const possibleKeys = [
                    `${sectionKey}_completed`,
                    `${sectionKey}Completed`,
                    `${sectionKey}_progress`,
                    `lessonEngine_${sectionKey}_completed`
                ];

                // R√©cup√©rer le√ßons compl√©t√©es
                for (const key of possibleKeys) {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        try {
                            const parsed = JSON.parse(stored);
                            if (Array.isArray(parsed)) {
                                data.completed = parsed;
                                break;
                            } else if (parsed.completed && Array.isArray(parsed.completed)) {
                                data.completed = parsed.completed;
                                break;
                            }
                        } catch (e) {
                            console.warn(`Erreur parsing ${key}:`, e);
                        }
                    }
                }

                // R√©cup√©rer XP
                const xpKeys = [`${sectionKey}_xp`, `${sectionKey}XP`, `lessonEngine_${sectionKey}_xp`];
                for (const key of xpKeys) {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        try {
                            const parsed = JSON.parse(stored);
                            data.xp = parsed.total || parsed.xp || parsed || 0;
                            break;
                        } catch (e) {
                            data.xp = parseInt(stored) || 0;
                        }
                    }
                }

                // R√©cup√©rer Streak
                const streakKeys = [`${sectionKey}_streak`, `${sectionKey}Streak`];
                for (const key of streakKeys) {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        try {
                            const parsed = JSON.parse(stored);
                            data.streak = parsed.currentStreak || parsed.streak || parsed || 0;
                            break;
                        } catch (e) {
                            data.streak = parseInt(stored) || 0;
                        }
                    }
                }

                // R√©cup√©rer Hearts
                const heartsKeys = [`${sectionKey}_hearts`, `${sectionKey}Hearts`];
                for (const key of heartsKeys) {
                    const stored = localStorage.getItem(key);
                    if (stored) {
                        try {
                            const parsed = JSON.parse(stored);
                            data.hearts = parsed.currentHearts || parsed.hearts || parsed || 5;
                            break;
                        } catch (e) {
                            data.hearts = parseInt(stored) || 5;
                        }
                    }
                }

                return data;
            }

            // Sauvegarder les donn√©es d'une section (format unifi√©)
            static saveSectionData(sectionKey, data) {
                if (data.completed !== undefined) {
                    localStorage.setItem(`${sectionKey}_completed`, JSON.stringify(data.completed));
                }
                if (data.xp !== undefined) {
                    localStorage.setItem(`${sectionKey}_xp`, JSON.stringify({ total: data.xp }));
                }
                if (data.streak !== undefined) {
                    localStorage.setItem(`${sectionKey}_streak`, JSON.stringify({ currentStreak: data.streak }));
                }
                if (data.hearts !== undefined) {
                    localStorage.setItem(`${sectionKey}_hearts`, JSON.stringify({ currentHearts: data.hearts }));
                }
            }
        }

        // ========================================
        // STATS GLOBALES (HEADER)
        // ========================================
        
        function loadGlobalStats() {
            let totalXP = 0;
            let maxStreak = 0;
            let minHearts = 5;
            let totalCompleted = 0;

            SECTIONS_CONFIG.forEach(section => {
                const data = UnifiedStorage.getSectionData(section.key);
                
                totalXP += data.xp;
                maxStreak = Math.max(maxStreak, data.streak);
                minHearts = Math.min(minHearts, data.hearts);
                totalCompleted += data.completed.length;
            });

            // Affichage
            document.getElementById('global-streak').innerText = maxStreak;
            document.getElementById('global-hearts').innerText = minHearts;
            document.getElementById('global-xp').innerText = totalXP;
            
            // Calcul niveau global (1 niveau = 200 XP)
            const globalLevel = Math.floor(totalXP / 200) + 1;
            document.getElementById('global-level').innerText = globalLevel;

            console.log('üìä Stats Globales:', {
                totalXP,
                maxStreak,
                minHearts,
                totalCompleted,
                globalLevel
            });
        }

        // ========================================
        // PROGRESSION PAR SECTION
        // ========================================
        
        function loadSectionsProgress() {
            SECTIONS_CONFIG.forEach(section => {
                const data = UnifiedStorage.getSectionData(section.key);
                
                const completedCount = data.completed.length;
                const percentage = Math.round((completedCount / section.totalLessons) * 100);
                
                // Mise √† jour affichage
                const completedEl = document.getElementById(`${section.key}-completed`);
                const xpEl = document.getElementById(`${section.key}-xp`);
                const progressEl = document.getElementById(`${section.key}-progress`);
                const percentageEl = document.getElementById(`${section.key}-percentage`);
                
                if (completedEl) completedEl.innerText = completedCount;
                if (xpEl) xpEl.innerText = data.xp;
                if (progressEl) progressEl.style.width = percentage + '%';
                if (percentageEl) percentageEl.innerText = percentage + '%';

                console.log(`üìö ${section.name}:`, {
                    completed: completedCount,
                    xp: data.xp,
                    percentage: percentage + '%'
                });
            });
        }

        // ========================================
        // RECOMMANDATION PERSONNALIS√âE
        // ========================================
        
        function showRecommendation() {
            let minProgress = 100;
            let recommendedSection = SECTIONS_CONFIG[0];

            SECTIONS_CONFIG.forEach(section => {
                const data = UnifiedStorage.getSectionData(section.key);
                const progress = (data.completed.length / section.totalLessons) * 100;
                
                if (progress < minProgress) {
                    minProgress = progress;
                    recommendedSection = section;
                }
            });

            // Affichage recommandation si progression < 100%
            if (minProgress < 100) {
                const banner = document.getElementById('recommendation-banner');
                const message = document.getElementById('recommendation-message');
                
                message.innerHTML = `Essaie <strong>${recommendedSection.emoji} ${recommendedSection.name}</strong> pour progresser !`;
                banner.style.display = 'flex';
                
                // Clic sur banni√®re ‚Üí redirection
                banner.style.cursor = 'pointer';
                banner.onclick = () => window.location.href = recommendedSection.url;
            }
        }

        // ========================================
        // DEBUG MODE (CONSOLE)
        // ========================================
        
        window.DashboardDebug = {
            showAllData: () => {
                console.log('=== DONN√âES GLOBALES ===');
                SECTIONS_CONFIG.forEach(section => {
                    console.log(`\nüìö ${section.name}:`, UnifiedStorage.getSectionData(section.key));
                });
            },
            
            resetSection: (sectionKey) => {
                const keys = Object.keys(localStorage).filter(k => k.startsWith(sectionKey));
                keys.forEach(k => localStorage.removeItem(k));
                console.log(`‚úÖ Section ${sectionKey} r√©initialis√©e`);
                location.reload();
            },
            
            addTestData: (sectionKey) => {
                UnifiedStorage.saveSectionData(sectionKey, {
                    completed: [0, 1, 2],
                    xp: 150,
                    streak: 5,
                    hearts: 4
                });
                console.log(`‚úÖ Donn√©es test ajout√©es pour ${sectionKey}`);
                location.reload();
            }
        };

        console.log('üí° Debug disponible: DashboardDebug.showAllData()');
    </script>
</body>
</html>
